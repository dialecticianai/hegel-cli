# Execution mode workflow - optimized for production resilience
mode: execution
start_node: spec

nodes:
  spec:
    prompt: |
      You are in the SPEC phase of Document-Driven Development (Execution Mode).

      {{SPEC_WRITING}}

      Your task: Write a production-grade behavioral contract.
      {{?context_note}}

      Execution mode requirements:
      - Comprehensive error handling scenarios
      - Performance and scaling considerations
      - Security and validation rules
      - Complete edge case coverage
      - Production-ready acceptance criteria

      Respond with your completed SPEC.md content.
    transitions:
      - when: "spec_complete"
        to: plan

  plan:
    prompt: |
      You are in the PLAN phase of Document-Driven Development (Execution Mode).

      {{PLAN_WRITING}}

      Your task: Create a rigorous implementation plan.
      {{?context_note}}

      Execution mode requirements:
      - Strict TDD with comprehensive test coverage
      - Error handling for all failure modes
      - Integration testing strategy
      - Performance validation steps
      - Security considerations at each step

      Respond with your completed PLAN.md content.
    transitions:
      - when: "plan_complete"
        to: code

  code:
    prompt: |
      You are in the CODE phase of Document-Driven Development (Execution Mode).

      Implement the system following the PLAN.md steps with production quality.
      {{?context_note}}

      Execution mode requirements:
      - Full test coverage (unit + integration)
      - Comprehensive error handling
      - Input validation and sanitization
      - Performance optimization where needed
      - Clear documentation and logging

      Respond when code is complete and all tests pass.
    rules:
      - type: repeated_command
        pattern: "cargo (build|check|test)"
        threshold: 5
        window: 120
      - type: repeated_file_edit
        path_pattern: "src/.*"
        threshold: 8
        window: 240
      - type: token_budget
        max_tokens: 8000
      - type: phase_timeout
        max_duration: 600
    transitions:
      - when: "code_complete"
        to: code_review

  code_review:
    prompt: |
      You are in the CODE_REVIEW phase of Document-Driven Development (Execution Mode).

      {{CODE_MAP_WRITING}}

      Your task: Update CODE_MAP.md files for areas touched during implementation.
      {{?context_note}}

      Focus on:
      - Identify which directories were modified during CODE phase
      - Update or create CODE_MAP.md files for those directories
      - Ensure descriptions accurately reflect current code structure
      - Keep descriptions concise (1-3 sentences per file)
      - Follow the code_map_style configured for this project

      Respond when CODE_MAP updates are complete.
    transitions:
      - when: "review_complete"
        to: readme

  readme:
    prompt: |
      You are in the README phase of Document-Driven Development (Execution Mode).

      {{README_WRITING}}

      Your task: Create production-ready README.md.

      Include:
      - System overview and purpose
      - Installation and setup
      - API documentation
      - Usage examples
      - Error handling guide
      - Performance characteristics
      - Integration points

      Respond with your completed README.md content.
    transitions:
      - when: "readme_complete"
        to: done

  done:
    transitions: []