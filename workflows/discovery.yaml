# Discovery mode workflow - optimized for learning density
mode: discovery
start_node: spec

nodes:
  spec:
    summary: Write a minimal behavioral contract defining inputs, outputs, and test scenarios.
    prompt: |
      You are in the SPEC phase of Dialectic-Driven Development (Discovery Mode).

      {{SPEC_WRITING}}

      Your task: Write a minimal behavioral contract.
      {{?context_note}}

      Focus on:
      - Precise input/output formats
      - Core operations with examples
      - Test scenarios (simple, complex, error cases)
      - Falsifiable success criteria

      Respond with your completed SPEC.md content.
    transitions:
      - when: "spec_complete"
        to: plan

  plan:
    summary: Create a test-driven implementation plan with numbered steps and clear goals.
    prompt: |
      You are in the PLAN phase of Dialectic-Driven Development (Discovery Mode).

      {{PLAN_WRITING}}

      Your task: Create a test-driven implementation plan.
      {{?context_note}}

      Focus on:
      - TDD discipline (Red → Green → Refactor)
      - Numbered steps with clear goals
      - Test strategies before implementation
      - Success criteria for each step

      Respond with your completed PLAN.md content.
    rules:
      - type: require_commits
        lookback_phases: 2
    transitions:
      - when: "plan_complete"
        to: code

  code:
    summary: Implement the system following TDD, completing one step at a time with commits.
    prompt: |
      You are in the CODE phase of Dialectic-Driven Development (Discovery Mode).

      Implement the system following the PLAN.md steps.
      {{?context_note}}

      Focus on:
      - Follow TDD: write tests first, then implementation
      - Complete one numbered step at a time
      - Keep functions small and focused
      - Commit after each step completion

      Respond when code is complete and all tests pass.
    rules:
      - type: require_commits
        lookback_phases: 1
      - type: repeated_command
        pattern: "cargo (build|check|test)"
        threshold: 6
        window: 180
      - type: repeated_file_edit
        path_pattern: "src/.*"
        threshold: 10
        window: 300
      - type: token_budget
        max_tokens: 10000
    transitions:
      - when: "code_complete"
        to: learnings

  learnings:
    summary: Extract insights from implementation including what worked, constraints, and pivots.
    prompt: |
      You are in the LEARNINGS phase of Dialectic-Driven Development (Discovery Mode).

      {{LEARNINGS_WRITING}}

      Your task: Extract insights from building the system.
      {{?context_note}}

      Focus on:
      - What worked vs. what failed
      - Technical constraints discovered
      - Pivots and their rationale
      - Key architectural decisions
      - Recommendations for future work

      Respond with your completed LEARNINGS.md content.
    transitions:
      - when: "learnings_complete"
        to: readme
      - when: "restart_cycle"
        to: spec

  readme:
    summary: Create a concise README summarizing the toy model for future AI context refresh.
    prompt: |
      You are in the README phase of Dialectic-Driven Development (Discovery Mode).

      {{README_WRITING}}

      Your task: Create a README.md summarizing the toy model for future AI context refresh.

      **Toy README Requirements:**

      **Length**: 100-200 words total

      **Required Structure:**
      ```markdown
      # toy_name
      Brief description of what it does and key technology/pattern

      ## Purpose
      2–3 sentences covering the core problem solved, architectural approach, and role in broader integration.

      ## Key API
      ```
      primary_operation(input) -> output
      secondary_operation(config) -> result
      utility_function(data) -> transformed
      ```

      ## Core Concepts
      - Key data structures or abstractions
      - Critical constraints or assumptions
      - Integration points with other components
      - Important design patterns

      ## Gotchas
      - Known limitations or scale constraints
      - Common usage mistakes
      - Performance considerations
      - Integration pitfalls

      ## Quick Test
      `command to run most representative test`
      ```

      Write the README summarizing what was built and key learnings.

      Respond with your completed README.md content.
    rules:
      - type: require_commits
        lookback_phases: 2
    transitions:
      - when: "readme_complete"
        to: done

  done:
    transitions: []